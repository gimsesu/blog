---
title: Elasticsearch ì„¤ì¹˜ ì‹œ vm.max_map_count ê°’ ë³€ê²½í•˜ê¸°
date: 2021-04-18
slug: "/elasticsearch-change-vm-max-map-count"
description: Elasticsearchë¥¼ ì„¤ì¹˜í•  ë•Œ Linux kernel parameterì¸ "vm.max_map_count" ê°’ì„ ë³€ê²½í•˜ëŠ” ë°©ë²•ê³¼ ê·¸ ì´ìœ ë¥¼ ì•Œì•„ë³¸ë‹¤.
tags:
  - Elastic Stack
  - Docker
  - Linux
  - Computer Science
---


Linux í™˜ê²½ì—ì„œ Elasticsearchê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ê¸° ìœ„í•´ì„œëŠ” `vm.max_map_count` ê°’ì„ ë³€ê²½í•´ì•¼ í•œë‹¤. 

ì´ ê°’ì€ ë¬´ì—‡ì´ê³ , ì™œ ë³€ê²½í•´ì•¼ í•˜ëŠ”ì§€ë¥¼ ì•Œì•„ë³´ì.

## ğŸ§° ì¤€ë¹„ë¬¼

- Elasticsearch v7.x
- Ubuntu 18.04.x LTS
- Docker

## vm.max_map_count is too low

Dockerë¥¼ ì´ìš©í•´ Elasticsearchë¥¼ ì„¤ì¹˜í–ˆìœ¼ë‚˜ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ë‹¤. í•´ë‹¹ ì»¨í…Œì´ë„ˆì˜ ë¡œê·¸ë¥¼ í™•ì¸í•˜ë‹ˆ ì´ëŸ° ì—ëŸ¬ê°€ ë–´ë‹¤. 

```shell
$ sudo docker logs es01

ERROR: [1] bootstrap checks failed 
[1]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
```

vm.max_map_count ê°’ì´ ë‚®ìœ¼ë‹ˆ ìƒí–¥í•˜ë¼ëŠ” ë‚´ìš©ì´ì—ˆë‹¤.

### ì˜¬ë¦¬ì§€ ë­!

vm.max_map_countì˜ ê¸°ë³¸ê°’ì€ Linuxì˜ ê²½ìš° `65,530`ì´ë‹¤. Elasticsearchë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” ìµœì†Œ `262,144`ë¡œ [ìƒí–¥í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•œë‹¤.](https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html#_set_vm_max_map_count_to_at_least_262144)

```shell
$ sysctl vm.max_map_count

vm.max_map_count = 65530
```

ë³€ê²½ ë°©ë²•ì€ OSì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤. ë‚˜ëŠ” Linux(Ubuntu) í™˜ê²½ì—ì„œ Elasticsearchë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤.

ê°’ì„ ë³€ê²½í•˜ëŠ” ë°©ì‹ì€ í¬ê²Œ ë‘ ê°€ì§€ê°€ ìˆë‹¤. 'ì¼ì‹œì ' í˜¹ì€ 'ì˜êµ¬ì '

### ì¼ì‹œì  ë³€ê²½

í˜„ì¬ ì„¸ì…˜ ê¸°ê°„ ë™ì•ˆë§Œ ì§€ì†ëœë‹¤. ì´ ë°©ì‹ì€ í˜¸ìŠ¤íŠ¸ê°€ ì¬ë¶€íŒ…ë˜ë©´ ì›ë˜ ê°’ìœ¼ë¡œ ì¬ì„¤ì •ëœë‹¤.

```shell
sysctl -w vm.max_map_count=262144
```

### ì˜êµ¬ì  ë³€ê²½

`/etc/sysctl.conf` íŒŒì¼ì„ ì§ì ‘ í¸ì§‘í•œ í›„ í˜¸ìŠ¤íŠ¸ë¥¼ ì¬ë¶€íŒ…í•œë‹¤. í˜¹ì€ `sysctl -p` ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ ì¬ë¶€íŒ…í•˜ì§€ ì•Šê³  ë°”ë¡œ ë³€ê²½ ì‚¬í•­ì„ ì ìš©í•  ìˆ˜ ìˆë‹¤.

```shell
$ vi /etc/sysctl.conf

# ì‘ì„±
vm.max_map_count=262144
```

ë‚˜ëŠ” Elasticsearchë¥¼ í”„ë¡œë•ì…˜ ë ˆë²¨ì—ì„œ ì‚¬ìš©í•˜ê³  ì‹¶ì—ˆê¸° ë•Œë¬¸ì— ì˜êµ¬ì ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ë°©ì‹ì„ íƒí–ˆë‹¤.

### í™•ì¸

ê°’ì„ ë³€ê²½ í›„ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```shell
$ sysctl vm.max_map_count

vm.max_map_count = 262144
```

ì´í›„ Elasticsearch ì»¨í…Œì´ë„ˆë¥¼ ì¬ì‹¤í–‰í•˜ë‹ˆ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

### í•˜ë¼ê³  í•´ì„œ í•˜ê¸´ í–ˆëŠ”ë°...

ì¹œì ˆí•œ ì—ëŸ¬ ë©”ì‹œì§€ ë•ì— ìˆ˜ì›”í•˜ê²Œ ë¬¸ì œë¥¼ í•´ê²°í–ˆë‹¤. í•˜ì§€ë§Œ í˜¸ê¸°ì‹¬ì´ ë‚¨ëŠ”ë‹¤. vm.max_map_countëŠ” ë¬´ì—‡ì´ê³ , ì™œ ìˆ˜ì •í•´ì•¼ í•˜ëŠ” ê±¸ê¹Œ? ğŸ•µğŸ¼

## vm.max_map_count

[kernel.org](https://www.kernel.org/doc/Documentation/sysctl/vm.txt)ì— ì‘ì„±ëœ ì„¤ëª…ì´ë‹¤.

> **max_map_count:**
>
> This file contains the maximum number of memory map areas a process
> may have. Memory map areas are used as a side-effect of calling
> malloc, directly by mmap, mprotect, and madvise, and also when loading shared libraries.
>
> While most applications need less than a thousand maps, certain
> programs, particularly malloc debuggers, may consume lots of them,
> e.g., up to one or two maps per allocation.
>
> The default value is 65536.

> ì´ íŒŒì¼ì€ í”„ë¡œì„¸ìŠ¤ê°€ ê°€ì§ˆ ìˆ˜ ìˆëŠ” **ìµœëŒ€ ë©”ëª¨ë¦¬ ë§µ ì˜ì—­ ìˆ˜**ë¥¼ í¬í•¨í•œë‹¤. ë©”ëª¨ë¦¬ ë§µ ì˜ì—­ì€ mmap, mprotect, ê·¸ë¦¬ê³  madviseì— ì˜í•œ malloc í˜¸ì¶œì˜ ì§ì ‘ì ì¸ ë¶€ì‘ìš©ìœ¼ë¡œ ì‚¬ìš©ë˜ë©°, ë˜í•œ ê³µìœ  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ë•Œë„ ì‚¬ìš©ëœë‹¤.
>
> ëŒ€ë¶€ë¶„ì˜ ì‘ìš© í”„ë¡œê·¸ë¨ì—ëŠ” ì²œ ê°œ ë¯¸ë§Œì˜ ë§µì´ í•„ìš”í•˜ì§€ë§Œ íŠ¹ì • í”„ë¡œê·¸ë¨(íŠ¹íˆ malloc debugger)ì€ ë” ë§ì€ ë§µì„ ì†Œë¹„í•  ìˆ˜ ìˆë‹¤.
> ì˜ˆ: í• ë‹¹ ë‹¹ ìµœëŒ€ 1ê°œ ë˜ëŠ” 2ê°œì˜ ë§µ
>
> ê¸°ë³¸ê°’ì€ 65,536ì´ë‹¤.

vm.max_map_countëŠ” ë³€ìˆ˜ë¡œì„œ, `/proc/sys/vm/max_map_count` íŒŒì¼ì„ ê°€ë¦¬í‚¨ë‹¤. ì´ íŒŒì¼ì€ Linux kernelì˜ ë©”ëª¨ë¦¬ ë§µ* ì˜ì—­ì˜ ìµœëŒ€ ê°œìˆ˜ë¥¼ ì¡°ì‘í•  ìˆ˜ ìˆë‹¤. 

ë©”ëª¨ë¦¬ ë§¤í•‘ ì‘ì—…ì´ ë§ì´ ì¼ì–´ë‚˜ëŠ” í”„ë¡œì„¸ìŠ¤ì¼ìˆ˜ë¡ ê°€ìƒ ë©”ëª¨ë¦¬ì—ì„œì˜ ì£¼ì†Œ ê³µê°„ì¸ [ê°€ìƒ ì£¼ì†Œ ê³µê°„](https://ko.wikipedia.org/wiki/%EA%B0%80%EC%83%81_%EC%A3%BC%EC%86%8C_%EA%B3%B5%EA%B0%84)ì„ ë§ì´ í•„ìš”ë¡œ í•œë‹¤. 

ğŸ’¡ [`Memory mapping`](https://jihooyim1.gitbooks.io/unixbasic/content/contents/08.html): `íŒŒì¼ì„ í”„ë¡œì„¸ìŠ¤ì˜ ë©”ëª¨ë¦¬ì— ë§¤í•‘í•˜ëŠ” ê²ƒì´ë‹¤. ì¦‰ í”„ë¡œì„¸ìŠ¤ì— ì „ë‹¬í•  ë°ì´í„°ê°€ ì €ì¥ëœ íŒŒì¼ì„ ì§ì ‘ í”„ë¡œì„¸ìŠ¤ì˜ ê°€ìƒ ì£¼ì†Œ ê³µê°„ìœ¼ë¡œ ë§¤í•‘í•œë‹¤. readì™€ write í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ë„ í”„ë¡œê·¸ë¨ ë‚´ë¶€ì—ì„œ ì •ì˜í•œ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•´ íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ì½ê±°ë‚˜ ì“¸ ìˆ˜ ìˆë‹¤.`

### ğŸ•µğŸ¼ ì¶”ì¸¡ 1

- ElasticsearchëŠ” ìì‹ ì˜ ê°€ìƒ ì£¼ì†Œ ê³µê°„ì— íŠ¹ì •í•œ íŒŒì¼ì„ ë§¤í•‘í•˜ëŠ” ì‘ì—…ì´ ë§ì´ ì¼ì–´ë‚˜ëŠ” ë“¯í•˜ë‹¤.

## Virtual memory

Elasticsearchë¥¼ í”„ë¡œë•ì…˜ ë ˆë²¨ì—ì„œ ì‚¬ìš©í•˜ë ¤ í•œë‹¤ë©´ ì‹¤í–‰ ì „ [ì¶©ë¶„í•œ ê°€ìƒ ë©”ëª¨ë¦¬ì˜ í™•ë³´ë¥¼ ê¶Œì¥](https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html)í•˜ë©° ê·¸ ë°©ë²•ìœ¼ë¡œ vm.max_map_countì˜ ì¡°ì‘ë²•ì„ ì•Œë ¤ì¤€ë‹¤.

> Elasticsearch uses a `mmapfs` directory by default to store its indices. The default operating system limits on mmap counts is likely to be too low, which may result in out of memory exceptions.


> ElasticsearchëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `mmapfs` ë””ë ‰í„°ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ë±ìŠ¤ë¥¼ ì €ì¥í•œë‹¤. ê¸°ë³¸ ìš´ì˜ ì²´ì œì—ì„œ ì„¤ì •í•œ mmap 
> ê°œìˆ˜ì˜ ì œí•œì€ ë„ˆë¬´ ë‚®ê¸° ë•Œë¬¸ì— ë©”ëª¨ë¦¬ ë¶€ì¡± ì˜ˆì™¸ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.

ê·¸ë¦¬ê³  ì´ ë°©ë²•ì„ ì–¸ê¸‰í•˜ëŠ” ê³¼ì •ì—ì„œ ë‚¯ì„  ìš©ì–´ì¸ [`mmapfs`](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules-store.html#mmapfs) ë””ë ‰í„°ë¦¬ì™€ `mmap`*ì´ ë‚˜ì˜¨ë‹¤.

ìœ„ ì¸ìš©ë¬¸ì—ì„œëŠ” 'mmap ê°œìˆ˜ì˜ ì œí•œì´ ë„ˆë¬´ ë‚®ë‹¤'ë¼ê³  í–ˆë‹¤.

> ğŸ’¡ [`mmap`](https://en.wikipedia.org/wiki/Mmap): ìœ ë‹‰ìŠ¤(Unix) ì‹œìŠ¤í…œ í˜¸ì¶œ(System call. syscall)ë¡œì„œ, ë©”ëª¨ë¦¬ ë§¤í•‘ì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜. ì‹¤í–‰í•˜ë©´ [ë©”ëª¨ë¦¬ ë§µ íŒŒì¼(memory mapped file)](https://ko.wikipedia.org/wiki/%EB%A9%94%EB%AA%A8%EB%A6%AC_%EB%A7%B5_%ED%8C%8C%EC%9D%BC)ì„ ìƒì„±í•œë‹¤.



### ğŸ•µğŸ¼ ì¶”ì¸¡ 2

- Elasticsearchê°€ mmapfs ë””ë ‰í„°ë¦¬ë¥¼ ì´ìš©í•˜ì—¬ [ì¸ë±ìŠ¤(Index)](https://esbook.kimjmin.net/03-cluster/3.2-index-and-shards)ë¥¼ ì €ì¥í•˜ëŠ” ê³¼ì •ì—ì„œ mmapì„ ì´ìš©í•œ ë§ì€ ìˆ˜ì˜ ë©”ëª¨ë¦¬ ë§¤í•‘ ì‘ì—…ì´ ë°œìƒí•  ìˆ˜ ìˆê³ , ê·¸ ê²°ê³¼ë¡œ ë§ì€ ë©”ëª¨ë¦¬ ë§µ íŒŒì¼ì´ ìƒì„±ë  ìˆ˜ ìˆë‹¤.

- Elasticsearch ê´€ì ì—ì„œ ë³¼ ë•Œ, Elasticsearchê°€ ìƒì„±í•˜ëŠ” ë©”ëª¨ë¦¬ ë§µ íŒŒì¼ì˜ ìˆ˜ì— ë¹„í•´ Linuxê°€ ì •í•´ë†“ì€ vm.max_map_countì˜ ê°’ì´ ë§¤ìš° ë‚®ê¸° ë•Œë¬¸ì— ìˆ˜ì •ì„ í•´ì•¼ í•œë‹¤.

## mmapfs

Elasticsearch ë¬¸ì„œì— ê¸°ìˆ í•´ ë†“ì€ mmapfsì˜ ì„¤ëª…ì´ë‹¤.

> The MMap FS type stores the shard index on the file system (maps to Lucene `MMapDirectory`) by mapping a file into memory (mmap). Memory mapping uses up a portion of the virtual memory address space in your process equal to the size of the file being mapped. Before using this class, be sure you have allowed plenty of [virtual address space](https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html).

> MMap FS ìœ í˜•ì€ íŒŒì¼ì„ ë©”ëª¨ë¦¬ì— ë§¤í•‘í•˜ì—¬(mmap) íŒŒì¼ ì‹œìŠ¤í…œ (Luceneì˜ `MMapDirectory`ì— ëŒ€ì‘í•œë‹¤.)ì— ìƒ¤ë“œ ì¸ë±ìŠ¤ë¥¼ ì €ì¥í•œë‹¤. ë©”ëª¨ë¦¬ ë§¤í•‘ì€ ë§¤í•‘ë˜ëŠ” íŒŒì¼ê³¼ ë™ì¼í•œ í¬ê¸°ì˜ í”„ë¡œì„¸ìŠ¤ ë‚´ ê°€ìƒ ë©”ëª¨ë¦¬ ì£¼ì†Œ ê³µê°„ì˜ ì¼ë¶€ë¥¼ ì‚¬ìš©í•œë‹¤. ì´ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì¶©ë¶„í•œ [ê°€ìƒ ì£¼ì†Œ ê³µê°„](https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html)ì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•´ì•¼ í•œë‹¤. 

ì—¬ê¸°ì„œ mmapfsëŠ” Elasticsearchì˜ ì¸ë±ìŠ¤ë¥¼ ì €ì¥í•˜ê³  ì ‘ê·¼í•˜ëŠ” [ì—¬ëŸ¬ íŒŒì¼ ì‹œìŠ¤í…œ êµ¬í˜„](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules-store.html) ì¤‘ í•˜ë‚˜ë¼ëŠ” ì‚¬ì‹¤ì„ ì•Œ ìˆ˜ ìˆë‹¤.

ë˜ 'file system'ì„ ì–¸ê¸‰í•˜ëŠ” ë¶€ë¶„ì—ì„œ 'Luceneì˜ `MMapDirectory`'ê°€ ë‚˜ì˜¨ë‹¤. 


### ğŸ•µğŸ¼ ì¶”ì¸¡ 3

- Elasticsearchê°€ mmapfs ì €ì¥ì†Œ ìœ í˜•ì„ ì´ìš©í•´ [ì¸ë±ìŠ¤(Index)](https://esbook.kimjmin.net/03-cluster/3.2-index-and-shards)ë¥¼ ì €ì¥í•˜ëŠ” ê³¼ì •ì—ì„œ mmapì„ ì´ìš©í•œ ë§ì€ ìˆ˜ì˜ ë©”ëª¨ë¦¬ ë§¤í•‘ ì‘ì—…ì´ ë°œìƒí•  ìˆ˜ ìˆê³ , ê·¸ ê²°ê³¼ë¡œ ë§ì€ ë©”ëª¨ë¦¬ ë§µ íŒŒì¼ì´ ìƒì„±ë  ìˆ˜ ìˆë‹¤.

- ê·¸ëŸ¬ë‚˜ ìì„¸í•œ ì €ì¥ ì›ë¦¬ëŠ” Elasticsearch ê³µì‹ ë¬¸ì„œì— ë” ì´ìƒ ë‚˜ì™€ ìˆì§€ ì•Šë‹¤. 

- MMapDirectoryë¥¼ ì•Œë©´ Elasticsearchê°€ ì¶©ë¶„í•œ ê°€ìƒ ì£¼ì†Œ ê³µê°„ì„ ë§ˆë ¨í•  ê²ƒì„ ê¶Œì¥í•˜ëŠ” ì´ìœ ë¥¼ ì•Œ ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤. 

## MMapDirectory

ElasticsearchëŠ” ì •ë³´ê²€ìƒ‰ ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ [Lucene](https://lucene.apache.org/core/)ì„ ê¸°ë°˜ìœ¼ë¡œ ë§Œë“¤ì–´ì¡Œë‹¤. [MMapDirectory](https://lucene.apache.org/core/6_3_0/core/org/apache/lucene/store/MMapDirectory.html)ëŠ” Luceneì˜ ì¸ë±ìŠ¤ë¥¼ ì €ì¥ ë° ê´€ë¦¬í•˜ëŠ” ë””ë ‰í„°ë¦¬ êµ¬í˜„ì´ë‹¤.

ê·¸ë¦¬ê³  Elasticsearchì˜ mmapfsì€ MMapDirectoryë¥¼ ì‚¬ìš©í•˜ì—¬ ì¸ë±ìŠ¤ë¥¼ ë‹¤ë£¨ëŠ” í˜•ì‹ì¸ ê²ƒì´ë‹¤. 


ì±… ã€Elasticsearch in Actionã€ì— ì“°ì¸ MMapDirectory ì„¤ëª…ì„ ì°¸ê³ í•´ë³´ì.

> MMapDirectory takes advantage of file system caches by asking the operating system to map the needed files in virtual memory in order to access that memory directly. To Elasticsearch, it looks as if all the files are available in memory, but that doesnâ€™t have to be the case. If your index size is larger than your available physical memory, the operating system will happily take unused files out of the caches to make room for new ones that need to be read. If Elasticsearch needs those uncached files again, theyâ€™ll be loaded in memory while other unused files are taken out and so on. The virtual memory used by MMapDirectory works similarly to the systemâ€™s virtual memory (swap), where the operating system uses the disk to page out unused memory in order to be able to serve multiple applications.



> MMapDirectoryëŠ” í•´ë‹¹ ë©”ëª¨ë¦¬ì— ì§ì ‘ ì•¡ì„¸ìŠ¤ í•˜ê¸° ìœ„í•´ í•„ìš”í•œ íŒŒì¼ì„ ê°€ìƒ ë©”ëª¨ë¦¬ì— ë§¤í•‘í•˜ë„ë¡ ìš´ì˜ ì²´ì œì— ìš”ì²­í•˜ì—¬ íŒŒì¼ ì‹œìŠ¤í…œ ìºì‹œë¥¼ í™œìš©í•œë‹¤. Elasticsearchì—ê²ŒëŠ” ëª¨ë“  íŒŒì¼ì´ ë©”ëª¨ë¦¬ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ê²ƒì²˜ëŸ¼ ë³´ì´ì§€ë§Œ ë°˜ë“œì‹œ ê·¸ëŸ´ í•„ìš”ëŠ” ì—†ë‹¤. ì¸ë±ìŠ¤ í¬ê¸°ê°€ ì‚¬ìš© ê°€ëŠ¥í•œ ì‹¤ì œ ë©”ëª¨ë¦¬ë³´ë‹¤ í¬ë©´ ìš´ì˜ ì²´ì œëŠ” ê¸°êº¼ì´ ìºì‹œì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” íŒŒì¼ì„ ê°€ì ¸ì™€ì„œ ì½ê³ ì í•˜ëŠ” ìƒˆ íŒŒì¼ì„ ìœ„í•œ ê³µê°„ì„ ë§Œë“ ë‹¤. Elasticsearchì— ìºì‹±ë˜ì§€ ì•Šì€ íŒŒì¼ì´ ë‹¤ì‹œ í•„ìš”í•œ ê²½ìš° í•´ë‹¹ íŒŒì¼ì€ ë©”ëª¨ë¦¬ì— ë¡œë“œë˜ê³  ë‹¤ë¥¸ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ì€ ì œê±°ëœë‹¤. MMapDirectoryì—ì„œ ì‚¬ìš©í•˜ëŠ” ê°€ìƒ ë©”ëª¨ë¦¬ëŠ” ì‹œìŠ¤í…œì˜ [ê°€ìƒ ë©”ëª¨ë¦¬ (ìŠ¤ì™‘)](http://www.simpleisbest.net/post/2011/05/02/Virtual-Memory-vs-Physical-Memory.aspx)ì™€ ìœ ì‚¬í•˜ê²Œ ì‘ë™í•œë‹¤. ì—¬ê¸°ì„œ ìš´ì˜ ì²´ì œëŠ” ë””ìŠ¤í¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì—¬ëŸ¬ ì‘ìš© í”„ë¡œê·¸ë¨ì„ ì§€ì›í•  ìˆ˜ ìˆë„ë¡ ì‚¬ìš©ë˜ì§€ ì•Šì€ ë©”ëª¨ë¦¬ë¥¼ [í˜ì´ì§•](https://ko.wikipedia.org/wiki/%ED%8E%98%EC%9D%B4%EC%A7%95) í•œë‹¤.

ì´ì²˜ëŸ¼ ElasticsearchëŠ” ìš´ì˜ ì²´ì œë¥¼ ì´ìš©í•˜ì—¬ ì¸ë±ìŠ¤ íŒŒì¼ë“¤ì„ ë©”ëª¨ë¦¬ì— ê°€ìƒìœ¼ë¡œ ë§¤í•‘í•˜ê³  íŒŒì¼ ì‹œìŠ¤í…œ ìºì‹œ*ë¥¼ ìƒì„±í•œë‹¤. ì´ ë•ë¶„ì— ê²€ìƒ‰ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ìºì‹œì— ë“¤ì–´ ìˆëŠ” ì‹ ì†í•˜ê²Œ ì¸ë±ìŠ¤ íŒŒì¼ì— ì ‘ê·¼í•´ ì‘ë‹µì„ ì œê³µí•œë‹¤.

> ğŸ’¡ [`íŒŒì¼ ì‹œìŠ¤í…œ ìºì‹œ(File System Cache)`](https://docs.oracle.com/cd/E19424-01/820-4811/anobm/index.html): ìµœê·¼ì— ë””ìŠ¤í¬ì—ì„œ ì½ì€ ë°ì´í„°ë“¤ì„ ë³´ê´€í•œë‹¤. ìµœê·¼ì— ë””ìŠ¤í¬ì—ì„œ ì½ì€ ë°ì´í„°ë¥¼ ë³´ê´€í•˜ê¸° ë•Œë¬¸ì— ì´í›„ ì‘ìš© í”„ë¡œê·¸ë¨ì€ ë””ìŠ¤í¬ì—ì„œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì½ì„ í•„ìš”ê°€ ì—†ê³  ìºì‹œì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.


### ğŸ™†ğŸ» ì•„í•˜!



ì´ëŸ¬í•œ ë°©ì‹ìœ¼ë¡œ ì¸ë±ìŠ¤ë¥¼ ê´€ë¦¬í•˜ëŠ” ê²ƒì€ êµ‰ì¥íˆ ë¹ ë¥¸ ì„±ëŠ¥ì„ ë³´ì¥í•œë‹¤. ê·¸ëŸ¬ë‚˜ Linuxì˜ ê²½ìš° ì‘ìš© í”„ë¡œê·¸ë¨ì´ í•œ ë²ˆì— ë„ˆë¬´ ë§ì€ íŒŒì¼ì„ ì—´ê±°ë‚˜ ë„ˆë¬´ ë§ì€ ë©”ëª¨ë¦¬ë¥¼ ë§¤í•‘í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ëŠ” ì œí•œì´ ìˆëŠ”ë°, ê·¸ê²Œ ë°”ë¡œ vm.max_map_count ê°’ì´ë‹¤.

[Bootstrap ê²€ì‚¬ ë‹¨ê³„](https://www.elastic.co/guide/en/elasticsearch/reference/7.12/bootstrap-checks.html)ì—ì„œ 

Elasticsearchì—ì„œ ì‚¬ìš©í•˜ëŠ” ì €ì¥ì†Œ ìœ í˜•ì€ [`hybridfs`](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules-store.html#hybridfs)ë‹¤. hybridfsëŠ” ìš´ì˜ ì²´ì œì— ë”°ë¼ mmapfsì™€ [`noifs`](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules-store.html#niofs)ë¥¼ ì ì ˆíˆ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•œë‹¤. ë”°ë¼ì„œ Elasticsearchë¥¼ ì„¤ì¹˜í•  ë•Œ `hybridfs`ë‚˜ `mmapfs`ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ `vm.max_map_count` ì‚¬ì „ì— ì„¤ì •í•´ì£¼ì–´ì•¼ í•œë‹¤.



## ê²°ë¡ 

ìƒê°ë³´ë‹¤ ê¸€ ì“°ëŠ” ê²Œ ë§¤ìš° í˜ë“¤ì—ˆë‹¤. íŠ¹ì • ê°’ì„ ì™œ ìˆ˜ì •í•´ì•¼ í• ê¹Œë¥¼ ì°¾ì•„ë³´ìëŠ” ê°€ë²¼ìš´ ë§ˆìŒì—ì„œ ì‹œì‘í•œ ê²ƒì´ ê°€ìƒ ë©”ëª¨ë¦¬, ë©”ëª¨ë¦¬ ë§¤í•‘ ë“±ì˜ ì €ìˆ˜ì¤€ ê°œë…ë¶€í„° Lucene, Javaì˜ í´ë˜ìŠ¤ê¹Œì§€ ëœ¯ì–´ë³´ê²Œ ë˜ëŠ” ëˆˆë©ì´ íš¨ê³¼ë¥¼ ê²½í—˜í–ˆë‹¤. 

'Elasticsearch ë¬¸ì„œì—ì„œ ì´ê±° ìˆ˜ì •í•˜ë¼ê³  í–ˆì–´ìš”. vm.max_map_count ê°’ì„ ìˆ˜ì •í•˜ë©´ ë¼ìš”!' ë¼ê³  ê°„ë‹¨íˆ ì“°ê³  ëë‚´ê¸°ì—” ë‚´ê°€ ì• ë§¤í•˜ê²Œ ì•Œê±°ë‚˜ ëª¨ë¥´ê³  ìˆë˜ ê°œë…ë“¤ì´ ë„ˆë¬´ ë§ì•˜ë‹¤. 

ë•ë¶„ì— ë©”ëª¨ë¦¬ ê´€ë¦¬ì™€ Elasticsearchì˜ ì¸ë±ìŠ¤ ì €ì¥ ë°©ì‹ì— ëŒ€í•´ ê¹Šì€ ê³µë¶€ë¥¼ í•  ìˆ˜ ìˆì—ˆë˜ ê³„ê¸°ê°€ ë˜ì—ˆë‹¤. í˜¸ê¸°ì‹¬ì€ ì¢‹ì€ ê²ƒì´ë‹¤... 




---



## ğŸ“œì°¸ê³ 


- Radu, G., Matthew, L. H., and Roy R. (2015). Chapter 10. Improving performance. Elasticsearch in Action. Manning Publications.
- [Elasticsearch: Max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144] - Stack Overflow(Website. 2021.04.15)](https://stackoverflow.com/questions/51445846/elasticsearch-max-virtual-memory-areas-vm-max-map-count-65530-is-too-low-inc)
- Elasticsearch Guide [7.12] | Elastic(Website. 2021.04.15)
  - [Install Elasticsearch with Docker](https://www.elastic.co/guide/en/elasticsearch/reference/7.12/docker.html#docker-prod-prerequisites)
  - [Virtual memory](https://www.elastic.co/guide/en/elasticsearch/reference/current/vm-max-map-count.html)
  - [Store](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules-store.html#mmapfs)
- [Documentation for /proc/sys/vm/*	kernel version 2.6.29(Website. 2021.04.15)](https://www.kernel.org/doc/Documentation/sysctl/vm.txt)
- [ë©”ëª¨ë¦¬ ë§µ - ìœ„í‚¤ë°±ê³¼, ìš°ë¦¬ ëª¨ë‘ì˜ ë°±ê³¼ì‚¬ì „(Website. 2021.04.15)](https://ko.wikipedia.org/wiki/%EB%A9%94%EB%AA%A8%EB%A6%AC_%EB%A7%B5)
- [8. ë©”ëª¨ë¦¬ ë§¤í•‘ Â· UNIXBasic(Website. 2021.04.15)](https://jihooyim1.gitbooks.io/unixbasic/content/contents/08.html)
- [mmap - Wikipedia(Website. 2021.04.15)](https://en.wikipedia.org/wiki/Mmap)
- [Apache Lucene - Apache Lucene Core(Website. 2021.04.16)](https://lucene.apache.org/core/)
- [MMapDirectory (Lucene 6.3.0 API)(Website. 2021.04.17)](https://lucene.apache.org/core/6_3_0/core/org/apache/lucene/store/MMapDirectory.html)
- [Use Luceneâ€™s MMapDirectory on 64bit platforms, please!(Website. 2021.04.16)](https://blog.thetaphi.de/2012/07/use-lucenes-mmapdirectory-on-64bit.html)
- [ë©”ëª¨ë¦¬ ë§µ íŒŒì¼ - ìœ„í‚¤ë°±ê³¼, ìš°ë¦¬ ëª¨ë‘ì˜ ë°±ê³¼ì‚¬ì „(Website. 2021.04.17)](https://ko.wikipedia.org/wiki/%EB%A9%94%EB%AA%A8%EB%A6%AC_%EB%A7%B5_%ED%8C%8C%EC%9D%BC)
- [SimpleIsBest.NET | ê°€ìƒ ë©”ëª¨ë¦¬ì˜ ê¸°ë³¸ ê°œë…(Website. 2021.04.18)](http://www.simpleisbest.net/post/2011/05/02/Virtual-Memory-vs-Physical-Memory.aspx)
- [í˜ì´ì§• - ìœ„í‚¤ë°±ê³¼, ìš°ë¦¬ ëª¨ë‘ì˜ ë°±ê³¼ì‚¬ì „(Website. 2021.04.18)](https://ko.wikipedia.org/wiki/%ED%8E%98%EC%9D%B4%EC%A7%95)

